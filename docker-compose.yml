name: arrdocker

services:
  # ── VPN Gateway ──────────────────────────────────────────────
  gluetun:
    image: qmcgaw/gluetun
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - SERVER_COUNTRIES=${VPN_SERVER_COUNTRY:-Netherlands}
      - HTTPPROXY=on
      - HTTPPROXY_LISTENING_ADDRESS=:8888
      - TZ=${TZ}=value
    ports:
      # Sonarr
      - "8989:8989"
      # Radarr
      - "7878:7878"
      # Prowlarr
      - "9696:9696"
      # SABnzbd
      - "8080:8080"
      # Gluetun HTTP proxy (used by vpn-exporter for IP verification)
      - "8888:8888"
      # Gluetun control API (used by vpn-exporter for VPN status)
      - "8000:8000"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "--timeout=10", "http://localhost:8000/v1/publicip/ip"]
      interval: 60s
      timeout: 15s
      retries: 3
      start_period: 30s
    volumes:
      - ./arrdrive/config/gluetun:/gluetun
    restart: unless-stopped

  # ── VPN-Routed Services ─────────────────────────────────────
  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./arrdrive/config/sonarr:/config
      - ./arrdrive/data:/data
    restart: unless-stopped

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./arrdrive/config/radarr:/config
      - ./arrdrive/data:/data
    restart: unless-stopped

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./arrdrive/config/prowlarr:/config
    restart: unless-stopped

  sabnzbd:
    image: lscr.io/linuxserver/sabnzbd:latest
    container_name: sabnzbd
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./arrdrive/config/sabnzbd:/config
      - ./arrdrive/data/sabnzbd:/data/sabnzbd
    restart: unless-stopped

  # ── Media Server ────────────────────────────────────────────
  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - VERSION=docker
      - PLEX_CLAIM=${PLEX_CLAIM_TOKEN}
    devices:
      - /dev/dri:/dev/dri
    ports:
      - "32400:32400"
      - "1900:1900/udp"
      - "5353:5353/udp"
      - "8324:8324"
      - "32410:32410/udp"
      - "32412:32412/udp"
      - "32413:32413/udp"
      - "32414:32414/udp"
      - "32469:32469"
    volumes:
      - ./arrdrive/config/plex:/config
      - ./arrdrive/data/Media:/data/Media:ro
      - ./arrdrive/plex/tmp-transcode:/tmp:rw  # Use host tmpfs for transcoding
    restart: unless-stopped

  # ── Plex Monitoring ─────────────────────────────────────────
  tautulli:
    image: lscr.io/linuxserver/tautulli:latest
    container_name: tautulli
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    ports:
      - "8181:8181"
    volumes:
      - ./arrdrive/config/tautulli/config:/config
      - ./arrdrive/config/tautulli/notifications:/notifications
    restart: unless-stopped

  # ── Request Management ──────────────────────────────────────
  overseerr:
    image: lscr.io/linuxserver/overseerr:latest
    container_name: overseerr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "5055:5055"
    volumes:
      - ./arrdrive/config/overseerr:/config
    restart: unless-stopped
